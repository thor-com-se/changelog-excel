Private Sub Worksheet_Change(ByVal Target As Range)
    ' Define the columns for the date, username, and time
    Const UsernameColumn As Integer = 1 ' Column A by default
    Const DateColumn As Integer = 2 ' Column B by default
    Const TimeColumn As Integer = 3 ' Column C by default

    Dim cell As Range
    Dim userName As String
    Dim currentDate As String
    Dim currentTime As String
    Dim nonEmptyCount As Integer
    Dim lastColumn As Integer
    Dim i As Integer
    Dim isCellBeingUpdated As Boolean
    
    ' Ensure that this handler doesn't run if it's called by code
    On Error GoTo ExitSub
    
    ' Temporarily disable events to prevent recursion
    Application.EnableEvents = False
    
    ' Get the full name of the user
    userName = Application.UserName
    
    ' Get the current date and time
    currentDate = Format(Date, "yyyy-mm-dd")
    
    ' Get the current time with two-digit milliseconds
    currentTime = Format(Now, "HH:mm:ss") & ":" & Format((Timer - Int(Timer)) * 100, "00")
    
    ' Loop through each changed cell
    For Each cell In Target
        ' Get the last column in the used range of the worksheet
        lastColumn = Me.Cells(cell.Row, Me.Columns.Count).End(xlToLeft).Column
        
        ' Initialize the non-empty cell counter and flag to check if the target cell is the only non-empty one
        nonEmptyCount = 0
        isCellBeingUpdated = False
        
        ' Check each cell in the row (excluding the date, time, and username columns)
        For i = 1 To lastColumn
            If i <> DateColumn And i <> TimeColumn And i <> UsernameColumn Then
                If Me.Cells(cell.Row, i).Value <> "" Then
                    nonEmptyCount = nonEmptyCount + 1
                    ' Check if the non-empty cell is the one being changed
                    If Me.Cells(cell.Row, i).Address = cell.Address Then
                        isCellBeingUpdated = True
                    End If
                End If
            End If
        Next i
        
        ' If only one cell in the row is non-empty and it's the cell being changed
        If nonEmptyCount = 1 And isCellBeingUpdated Then
            ' Update the username column with the user's full name
            Me.Cells(cell.Row, UsernameColumn).Value = userName
            ' Update the date column with the current date
            Me.Cells(cell.Row, DateColumn).Value = currentDate
            ' Update the time column with the current time including two-digit milliseconds
            Me.Cells(cell.Row, TimeColumn).Value = currentTime
        ElseIf nonEmptyCount = 0 Then
            ' If the entire row (excluding the date, time, and username columns) is empty, clear the date, time, and username columns
            Me.Cells(cell.Row, UsernameColumn).ClearContents
            Me.Cells(cell.Row, DateColumn).ClearContents
            Me.Cells(cell.Row, TimeColumn).ClearContents
        End If
    Next cell
    
ExitSub:
    ' Re-enable events after the changes are done
    Application.EnableEvents = True
    On Error Resume Next
End Sub